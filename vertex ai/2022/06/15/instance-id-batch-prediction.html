<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Adding InstanceID on Vertex AI Batch Prediction | ML300 in the Cloud Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Adding InstanceID on Vertex AI Batch Prediction" />
<meta name="author" content="Rafael Sanchez" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In Vertex AI Batch Prediction there is no way to pass Instance ID (or key ID) along with the inputs when using XGBoost or Sickit-learn prebuilt containers. This post shows how to do it using an Custom Container" />
<meta property="og:description" content="In Vertex AI Batch Prediction there is no way to pass Instance ID (or key ID) along with the inputs when using XGBoost or Sickit-learn prebuilt containers. This post shows how to do it using an Custom Container" />
<link rel="canonical" href="https://rafaelsf80.github.io/blog/vertex%20ai/2022/06/15/instance-id-batch-prediction.html" />
<meta property="og:url" content="https://rafaelsf80.github.io/blog/vertex%20ai/2022/06/15/instance-id-batch-prediction.html" />
<meta property="og:site_name" content="ML300 in the Cloud Blog" />
<meta property="og:image" content="https://rafaelsf80.github.io/blog/images/vertex.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-15T00:00:00-05:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://rafaelsf80.github.io/blog/images/vertex.png" />
<meta property="twitter:title" content="Adding InstanceID on Vertex AI Batch Prediction" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Rafael Sanchez"},"dateModified":"2022-06-15T00:00:00-05:00","datePublished":"2022-06-15T00:00:00-05:00","description":"In Vertex AI Batch Prediction there is no way to pass Instance ID (or key ID) along with the inputs when using XGBoost or Sickit-learn prebuilt containers. This post shows how to do it using an Custom Container","headline":"Adding InstanceID on Vertex AI Batch Prediction","image":"https://rafaelsf80.github.io/blog/images/vertex.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://rafaelsf80.github.io/blog/vertex%20ai/2022/06/15/instance-id-batch-prediction.html"},"url":"https://rafaelsf80.github.io/blog/vertex%20ai/2022/06/15/instance-id-batch-prediction.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://rafaelsf80.github.io/blog/feed.xml" title="ML300 in the Cloud Blog" /><link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">ML300 in the Cloud Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Adding InstanceID on Vertex AI Batch Prediction</h1><p class="page-description">In Vertex AI Batch Prediction there is no way to pass Instance ID (or key ID) along with the inputs when using XGBoost or Sickit-learn prebuilt containers. This post shows how to do it using an Custom Container</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-15T00:00:00-05:00" itemprop="datePublished">
        Jun 15, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Rafael Sanchez</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Vertex AI">Vertex AI</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#summary">Summary</a></li>
<li class="toc-entry toc-h2"><a href="#custom-container-image">Custom Container image</a></li>
<li class="toc-entry toc-h2"><a href="#set-up">Set up</a></li>
<li class="toc-entry toc-h2"><a href="#running-docker-locally">Running docker locally</a></li>
<li class="toc-entry toc-h2"><a href="#upload-and-online-deployment-in-vertex-ai-prediction">Upload and Online deployment in Vertex AI prediction</a></li>
<li class="toc-entry toc-h2"><a href="#batch-prediction-on-vertex-ai">Batch prediction on Vertex AI</a></li>
<li class="toc-entry toc-h2"><a href="#faq">FAQ</a></li>
</ul><h2 id="summary">
<a class="anchor" href="#summary" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summary</h2>

<p>In Vertex AI <strong>Batch Prediction</strong> <a href="https://issuetracker.google.com/issues/203029524">there is no way</a> to pass Instance ID (or key ID) along with the inputs when using XGBoost or Sickit-learn prebuilt containers. Due to the parallelization done in Vertex AI, 
the order of inputs can not be maintained, so even if the inputs are printed with outputs, because they are out of order, it may be complicated for large datasets to know what prediction results map to which instances.</p>

<p>A feature request is open and can be tracked <a href="https://issuetracker.google.com/issues/202080076">here</a>.</p>

<p>This tutorial shows a Custom Container for predictions that solves this issue for a Scikit learn model.
Using inputs with Instance IDs (on first column), they are removed before calling the prediction.</p>

<p>Example:</p>

<p>For this input (instance ID on first column):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mf">-0.37078722949973075</span><span class="p">,</span><span class="mf">-0.09383565010748596</span><span class="p">,</span><span class="mf">-0.11347464767250347</span><span class="p">,</span><span class="mf">0.12246106838945217</span><span class="p">,</span><span class="mf">0.10186437443386016</span><span class="p">,</span><span class="mf">0.1905715671716009</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>
<p>The following output is printed in Vertex AI Batch prediction (note instance ID is converted to <code class="language-plaintext highlighter-rouge">float</code>):</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">-0.37078722949973075</span><span class="p">,</span><span class="mf">-0.09383565010748596</span><span class="p">,</span><span class="mf">-0.11347464767250347</span><span class="p">,</span><span class="mf">0.12246106838945217</span><span class="p">,</span><span class="mf">0.10186437443386016</span><span class="p">,</span><span class="mf">0.1905715671716009</span><span class="p">]</span><span class="w">
</span><span class="err">]</span><span class="p">,</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">46</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<h2 id="custom-container-image">
<a class="anchor" href="#custom-container-image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Container image</h2>

<p>A Custom Container image for predictions is required. Custom Container image <a href="https://cloud.google.com/ai-platform-unified/docs/predictions/custom-container-requirements#image">requires</a> that the container must run an HTTP server. 
Specifically, the container must listen and respond to liveness checks, health checks, and prediction requests.</p>

<p>This tutorial uses <strong>FastAPI and Uvicorn</strong> to implement the HTTP server. 
The HTTP server must listen for requests on <code class="language-plaintext highlighter-rouge">0.0.0.0</code>. <a href="https://www.uvicorn.org">Uvicorn</a> is an ASGI web server implementation for Python. 
Uvicorn currently supports HTTP/1.1 and WebSockets. 
<a href="https://github.com/tiangolo/uvicorn-gunicorn-fastapi-docker">Here</a> is a docker image with Uvicorn managed by Gunicorn for high-performance FastAPI web applications in Python 3.6+ with performance auto-tuning. 
An uvicorn server is launched with:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uvicorn main:app <span class="nt">--host</span> 0.0.0.0 <span class="nt">--port</span> 7080
</code></pre></div></div>

<h2 id="set-up">
<a class="anchor" href="#set-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set up</h2>

<ol>
  <li>Train the model with <code class="language-plaintext highlighter-rouge">python3 train/train.py</code>. The training dataset is located at <a href="train/input_data.csv"><code class="language-plaintext highlighter-rouge">train/input_data.csv</code></a>
</li>
  <li>Move the resulting ..pkl model to the <code class="language-plaintext highlighter-rouge">custom/model</code> directory. The <code class="language-plaintext highlighter-rouge">custom</code> directory contains the <code class="language-plaintext highlighter-rouge">Dockerfile</code> to generate the Custom Container image. Follow ths instructions below under section <strong>Upload and Online deployment in Vertex AI prediction</strong>. It will upload the model to Vertex AI and, although not required for batch, will create an online endpoint.</li>
  <li>Make a Batch prediction following instructions under section below <strong>Batch prediction on Vertex AI</strong>.</li>
</ol>

<h2 id="running-docker-locally">
<a class="anchor" href="#running-docker-locally" aria-hidden="true"><span class="octicon octicon-link"></span></a>Running docker locally</h2>

<p>Build and run locally (for info see <a href="https://cloud.google.com/ai-platform/prediction/docs/getting-started-pytorch-container#run_the_container_locally_optional">here</a>)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> demo_basic_model <span class="nb">.</span>
docker run <span class="nt">-p</span> 7080:7080 <span class="nt">-e</span> <span class="nv">AIP_HTTP_PORT</span><span class="o">=</span>7080 <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">AIP_HEALTH_ROUTE</span><span class="o">=</span>/health <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">AIP_PREDICT_ROUTE</span><span class="o">=</span>/predict <span class="se">\</span>
    demo_basic_model:latest
<span class="o">[</span>...]
INFO:     Started server process <span class="o">[</span>1]
INFO:     Waiting <span class="k">for </span>application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:7080 <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
</code></pre></div></div>

<p>To access container shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">-p</span> 7080:7080 <span class="se">\</span>
    <span class="nt">--name</span><span class="o">=</span>demo_basic_model <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">AIP_HTTP_PORT</span><span class="o">=</span>7080 <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">AIP_HEALTH_ROUTE</span><span class="o">=</span>/health <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">AIP_PREDICT_ROUTE</span><span class="o">=</span>/predict <span class="se">\</span>
    <span class="nt">-e</span> <span class="nv">AIP_STORAGE_URI</span><span class="o">=</span><span class="s1">'gs://argolis-vertex-europewest4'</span> <span class="se">\</span>
    0395efe5870d <span class="se">\</span>
    /bin/bash
</code></pre></div></div>

<p>Prediction example:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST http://localhost:7080/predict  <span class="nt">-d</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">instances</span><span class="se">\"</span><span class="s2">: [[1,-0.37078722949973075,-0.09383565010748596,-0.11347464767250347,0.12246106838945217,0.10186437443386016,0.1905715671716009],[2,-0.37078722949973075,-0.09383565010748596,-0.11347464767250347,0.12246106838945217,0.10186437443386016,0.1905715671716009]]}"</span>
HTTP/1.1 200 OK
<span class="nb">date</span>: Sun, 03 Jul 2022 14:54:39 GMT
server: uvicorn
content-length: 21
content-type: application/json

<span class="o">{</span><span class="s2">"predictions"</span>:[5,5]<span class="o">}</span>
</code></pre></div></div>

<p>Prediction example with local file <code class="language-plaintext highlighter-rouge">instance_test.json</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-i</span> <span class="nt">-X</span> POST <span class="nt">-d</span> @custom/instances_test.json   <span class="nt">-H</span> <span class="s2">"Content-Type: application/json; charset=uost:7080/predict 
HTTP/1.1 200 OK
date: Sun, 03 Jul 2022 14:56:39 GMT
server: uvicorn
content-length: 21
content-type: application/json

{"</span>predictions<span class="s2">":[8,8]}
</span></code></pre></div></div>

<h2 id="upload-and-online-deployment-in-vertex-ai-prediction">
<a class="anchor" href="#upload-and-online-deployment-in-vertex-ai-prediction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Upload and Online deployment in Vertex AI prediction</h2>

<p>Push docker image to <strong>Artifact Registry</strong>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud auth configure-docker europe-west4-docker.pkg.dev
gcloud builds submit <span class="nt">--tag</span> europe-west4-docker.pkg.dev/argolis-rafaelsanchez-ml-dev/ml-pipelines-repo/demo_basic_model
</code></pre></div></div>

<p>Upload model to Vertex AI prediction:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">aiplatform</span>

<span class="n">STAGING_BUCKET</span> <span class="o">=</span> <span class="s">'gs://argolis-vertex-europewest4'</span>
<span class="n">PROJECT_ID</span> <span class="o">=</span> <span class="s">'argolis-rafaelsanchez-ml-dev'</span>
<span class="n">LOCATION</span> <span class="o">=</span> <span class="s">'europe-west4'</span>

<span class="n">aiplatform</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">PROJECT_ID</span><span class="p">,</span> <span class="n">staging_bucket</span><span class="o">=</span><span class="n">STAGING_BUCKET</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">LOCATION</span><span class="p">)</span>

<span class="n">DEPLOY_IMAGE</span> <span class="o">=</span> <span class="s">'europe-west4-docker.pkg.dev/argolis-rafaelsanchez-ml-dev/ml-pipelines-repo/demo_basic_model'</span> 
<span class="n">HEALTH_ROUTE</span> <span class="o">=</span> <span class="s">"/health"</span>
<span class="n">PREDICT_ROUTE</span> <span class="o">=</span> <span class="s">"/predict"</span>
<span class="n">SERVING_CONTAINER_PORTS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7080</span><span class="p">]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">aiplatform</span><span class="p">.</span><span class="n">Model</span><span class="p">.</span><span class="n">upload</span><span class="p">(</span>
    <span class="n">display_name</span><span class="o">=</span><span class="sa">f</span><span class="s">'custom-model-uvicorn'</span><span class="p">,</span>    
    <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s">'Scikit-learn mdoel with Uviron and FastAPI'</span><span class="p">,</span>
    <span class="n">serving_container_image_uri</span><span class="o">=</span><span class="n">DEPLOY_IMAGE</span><span class="p">,</span>
    <span class="n">serving_container_predict_route</span><span class="o">=</span><span class="n">PREDICT_ROUTE</span><span class="p">,</span>
    <span class="n">serving_container_health_route</span><span class="o">=</span><span class="n">HEALTH_ROUTE</span><span class="p">,</span>
    <span class="n">serving_container_ports</span><span class="o">=</span><span class="n">SERVING_CONTAINER_PORTS</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">resource_name</span><span class="p">)</span>

<span class="c1"># Retrieve a Model on Vertex
</span><span class="n">model</span> <span class="o">=</span> <span class="n">aiplatform</span><span class="p">.</span><span class="n">Model</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">resource_name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">resource_name</span><span class="p">)</span>

<span class="c1"># Deploy model
</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">deploy</span><span class="p">(</span>
      <span class="n">machine_type</span><span class="o">=</span><span class="s">'n1-standard-2'</span><span class="p">,</span> 
      <span class="n">sync</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>
<span class="n">endpoint</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>

<span class="c1"># Retrieve an Endpoint on Vertex
</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">aiplatform</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">(</span><span class="s">'projects/989788194604/locations/europe-west4/endpoints/4614905388473516032'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">endpoint</span><span class="p">.</span><span class="n">predict</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.16877874957321273</span><span class="p">,</span><span class="mf">0.20526086240043687</span><span class="p">,</span><span class="mf">0.011701852935588793</span><span class="p">,</span><span class="mf">1.3426588560447468</span><span class="p">,</span><span class="mf">0.28517943828011344</span><span class="p">,</span><span class="o">-</span><span class="mf">0.48931828100278363</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.16877874957321273</span><span class="p">,</span><span class="mf">0.20526086240043687</span><span class="p">,</span><span class="mf">0.011701852935588793</span><span class="p">,</span><span class="mf">1.3426588560447468</span><span class="p">,</span><span class="mf">0.28517943828011344</span><span class="p">,</span><span class="o">-</span><span class="mf">0.48931828100278363</span><span class="p">]]))</span>
<span class="c1"># Output: [8 8]
</span></code></pre></div></div>

<p>Predict using REST API online endpoint:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: Bearer </span><span class="si">$(</span>gcloud auth print-access-token<span class="si">)</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
https://europe-west4-aiplatform.googleapis.com/v1alpha1/projects/989788194604/locations/europe-west4/endpoints/4614905388473516032:predict <span class="se">\</span>
<span class="nt">-d</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">instances</span><span class="se">\"</span><span class="s2">: [[1,-0.37078722949973075,-0.09383565010748596,-0.11347464767250347,0.12246106838945217,0.10186437443386016,0.1905715671716009],[2,-0.37078722949973075,-0.09383565010748596,-0.11347464767250347,0.12246106838945217,0.10186437443386016,0.1905715671716009]]}"</span>
<span class="o">{</span>
  <span class="s2">"predictions"</span>: <span class="o">[</span>
    8,
    8
  <span class="o">]</span>,
  <span class="s2">"deployedModelId"</span>: <span class="s2">"8016169842207883264"</span>,
  <span class="s2">"model"</span>: <span class="s2">"projects/989788194604/locations/europe-west4/models/1804377746017615872"</span>,
  <span class="s2">"modelDisplayName"</span>: <span class="s2">"custom-model-uvicorn"</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="batch-prediction-on-vertex-ai">
<a class="anchor" href="#batch-prediction-on-vertex-ai" aria-hidden="true"><span class="octicon octicon-link"></span></a>Batch prediction on Vertex AI</h2>

<p>Launching a Batch prediction on Vertex AI with a table including Instance ID (<code class="language-plaintext highlighter-rouge">batch_input_data_with_id.csv</code>) on a first column generates now these outputs. 
Note results are in GCS in the folder <code class="language-plaintext highlighter-rouge">prediction-&lt;model-display-name&gt;-&lt;job-create-time&gt;</code>. Inside of it multiple files of type <code class="language-plaintext highlighter-rouge">prediction.results-00000-of-000XX</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">26.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.07885108639438881</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1464272109727935</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1828991258260679</span><span class="p">,</span><span class="w"> </span><span class="mf">0.61054018345157</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3088025135180327</span><span class="p">,</span><span class="w"> </span><span class="mf">0.19057156717160098</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">18.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5506425558573785</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.539030640110576</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.542388245344349</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.12157848914160675</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.9829072404913923</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.76127422027253748</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.16877874957321273</span><span class="p">,</span><span class="w"> </span><span class="mf">0.20526086240043687</span><span class="p">,</span><span class="w"> </span><span class="mf">0.011701852935588793</span><span class="p">,</span><span class="w"> </span><span class="mf">1.3426588560447468</span><span class="p">,</span><span class="w"> </span><span class="mf">0.28517943828011344</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.489318281002783638</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">25.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.6705461067624772</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5936856862810885</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5700007087137811</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.0977367192658425</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.0452721591194991</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.62529625063766058</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">4.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4007631172260054</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4854167746519732</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.41168925206237034</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12246106838945217</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4924921985521885</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.76127422027253748</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">8.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.7005219944887517</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.6042918471330752</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5810456940615539</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.3417762767969013</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.9507798581678222</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4893182810027836383</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">11.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5506425558573785</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4820155843264015</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4172117447362567</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.6096576042037246</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.12397222484064802</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.217362341733029828</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4906907804048293</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5117100582300658</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4761183332577119</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3656180466726657</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5917091145514494</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.62529625063766058</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">28.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8582241672775294</span><span class="p">,</span><span class="w"> </span><span class="mf">2.4080799533830155</span><span class="p">,</span><span class="w"> </span><span class="mf">2.205972275359794</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3665006259205111</span><span class="p">,</span><span class="w"> </span><span class="mf">3.2068813837059675</span><span class="p">,</span><span class="w"> </span><span class="mf">2.09426314205987748</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.37078722949973075</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.09383565010748596</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.11347464767250347</span><span class="p">,</span><span class="w"> </span><span class="mf">0.12246106838945217</span><span class="p">,</span><span class="w"> </span><span class="mf">0.10186437443386016</span><span class="p">,</span><span class="w"> </span><span class="mf">0.19057156717160098</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">10.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3108354540471815</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.4907476198969507</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.45955085523605266</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3656180466726657</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.3271306718867537</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.62529625063766058</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">22.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5506425558573785</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5144032456715388</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.500049134844553</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.12157848914160675</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.6200568048369525</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.489318281002783638</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mf">13.0</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.6705461067624772</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.6021956032997636</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.5681598778224857</span><span class="p">,</span><span class="w"> </span><span class="mf">-1.0977367192658425</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.9980260086436606</span><span class="p">,</span><span class="w"> </span><span class="mf">-0.62529625063766058</span><span class="p">],</span><span class="w"> </span><span class="nl">"prediction"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="faq">
<a class="anchor" href="#faq" aria-hidden="true"><span class="octicon octicon-link"></span></a>FAQ</h2>

<ul>
  <li>Q: 500 Internal server error after POST request: <code class="language-plaintext highlighter-rouge">ValueError: [TypeError("'numpy.int64' object is not iterable"), TypeError('vars() argument must have __dict__ attribute')]</code> <br>
A: Replace last line of the <code class="language-plaintext highlighter-rouge">@app.post</code> handler. Replace <code class="language-plaintext highlighter-rouge">return {"predictions": [item for item in outputs]}</code> with <code class="language-plaintext highlighter-rouge">return {"predictions": outputs.tolist()}</code>
</li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="rafaelsf80/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/vertex%20ai/2022/06/15/instance-id-batch-prediction.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Lists of technical posts and notebooks around doing Machine Learning in the Cloud</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/rafaelsf80" target="_blank" title="rafaelsf80"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/rafaelsf80" target="_blank" title="rafaelsf80"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
